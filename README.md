# udp_mirror

## üìå –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
–°—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å –ø—Ä–æ–±–ª–µ–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤, –≤ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–∏–µ–º–Ω–∏–∫–∞, —Ç–∞–∫–∏—Ö –∫–∞–∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –∏ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç—É—Ä, –Ω–æ —É –≤–∞—Å –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–≤–µ —Ü–µ–ª–∏ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏? –≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å —Ä–µ—à–∞–µ—Ç —ç—Ç—É –∑–∞–¥–∞—á—É.
`udp_mirror` - —ç—Ç–æ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è UDP-—Ç—Ä–∞—Ñ–∏–∫–∞. –û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ UDP-–ø–∞–∫–µ—Ç—ã –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤—ã–µ –∞–¥—Ä–µ—Å–∞.


## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- üì° –ú—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ü–µ–ª–µ–π
- üé≠ –ü–æ–¥–º–µ–Ω–∞ –∞–¥—Ä–µ—Å–æ–≤ –∏ –ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
- üèé –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä—è `goroutine`
- üìä –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
- üìâ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `pprof` –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ~~üîÑ –ì–æ—Ä—è—á–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ (`SIGHUP`)~~

---

## üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```sh
git clone https://github.com/Yurgers/udp_mirror.git
cd udp_mirror
go build -o udp_mirror ./cmd/server
```

---

## ‚öô –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–ü—Ä–∏–º–µ—Ä `config.yml`:

```yaml
pipeline:
  - name: "udp_mirror_1"
    input:
      host: "0.0.0.0"
      port: 9000
    targets:
      - host: 192.168.1.100
        port: 9001
      - host: 192.168.1.101
        port: 9002
        src_host: 172.0.0.11
        src_port: 9002
pprof:
  enabled: true
  listen: "localhost:6060"

prometheus:
  enabled: true
  listen: "localhost:9090"
```

---

## ‚ñ∂ –ó–∞–ø—É—Å–∫

```sh
./udp_mirror -f config.yml
```

–ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ:
```sh
./udp_mirror -f config.yml -d
```

–ì–æ—Ä—è—á–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞:
```sh
./udp_mirror -s reload
```

–û—Å—Ç–∞–Ω–æ–≤–∫–∞:
```sh
./udp_mirror -s quit
```

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ:
```sh
./udp_mirror -s stop
```


---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus
–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤ `config.yml`, –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ `http://localhost:9090/metrics`.

### pprof
–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤ `config.yml`, –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ `http://localhost:6060/debug/pprof/`.

---

## üîÑ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **Pipeline** (`pipeline.go`) - —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ UDP-–ø–∞–∫–µ—Ç–∞
- **Listener** (`udp_listener.go`) - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç UDP-–ø–∞–∫–µ—Ç—ã
- **WorkerManager** (`worker_manager.go`) - —É–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä—É–ø–ø–æ–π –≤–æ—Ä–∫–µ—Ä–æ–≤
- **Worker** (`worker.go`) - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –ø–∞–∫–µ—Ç—ã
- **Sender** (`udp_sender.go`) - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç UDP-–ø–∞–∫–µ—Ç—ã


---

